name: Build and Test

on:
  push:
    branches: [master, develop]
    paths: ["bleak/**", "tests/**", ".github/workflows/build_and_test.yml", "pyproject.toml"]
  pull_request:
    branches: [master, develop]
    paths: ["bleak/**", "tests/**", ".github/workflows/build_and_test.yml", "pyproject.toml"]
  workflow_dispatch:

jobs:
  build_desktop:
    name: "Build and test"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
    env:
      FORCE_COLOR: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Install uv and set up Python ${{ matrix.python-version }}
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv tool install tox --with tox-uv
          uv tool install poetry

      - name: Test with pytest
        run: tox -e py -- -v --cov-report=xml --junitxml=junit.xml -o junit_family=legacy

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          report_type: coverage
          flags: ${{ matrix.os }}-py${{ matrix.python-version }}
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v5
        with:
          report_type: test_results
          flags: ${{ matrix.os }}-py${{ matrix.python-version }}
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Type checking
        # We don't do this in the lint job because we have conditionals
        # on both the platform and the Python version in the code, so we
        # need to check each matrix combination.
        run: |
          tox -e typecheck


  integration_tests_bluez:
    name: "BlueZ integration tests"
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4

      - name: Install QEMU
        run: sudo apt-get update && sudo apt-get install -y qemu-system-x86 qemu-utils qemu-kvm

      - name: Enable KVM group permissions
        run: |
          sudo chmod 666 /dev/kvm

      - name: Build and boot Alpine VM
        run: ./.github/alpine-vm/start-alpine-vm.sh

      - name: Install Python and dependencies in VM
        run: |
          ./.github/alpine-vm/vm-ssh.sh '
            bluetoothctl --version
            echo "export PATH=\"\$HOME/.local/bin:\$PATH\"" >> ~/.profile
            source ~/.profile
            uv python install ${{ matrix.python-version }}
            uv python pin ${{ matrix.python-version }}
            uv tool install tox --with tox-uv
            uv tool install poetry
          '

      - name: Run pytest in VM
        run: |
          ./.github/alpine-vm/vm-ssh.sh '
            export FORCE_COLOR=1
            export CI=true
            export GITHUB_ACTIONS=true
            tox -e py -- --bleak-bluez-vhci -v --cov-report=xml --junitxml=junit.xml -o junit_family=legacy
          '

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          report_type: coverage
          flags: bluez-integration-py${{ matrix.python-version }}
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v5
        with:
          report_type: test_results
          flags: bluez-integration-py${{ matrix.python-version }}
          token: ${{ secrets.CODECOV_TOKEN }}
